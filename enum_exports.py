import os
import pefile
from collections import defaultdict
import sys

def checkFile(malware_file):
    try:
        pe = pefile.PE(malware_file)
    except pefile.PEFormatError as err:
        print("Is not a PE File!")
        return
    if hasattr(pe, 'DIRECTORY_ENTRY_EXPORT'):
        d = defaultdict(int)
        dictOffset = defaultdict(int)
        dictName = defaultdict(str)
        isSameAddr=False
        isOffsetVal = False
        isNameSame = False
        matchName=""
        offsetName=""
        sameAddr=-1;
        prevAddr=-1
        for exp in pe.DIRECTORY_ENTRY_EXPORT.symbols:
            d[exp.address + pe.OPTIONAL_HEADER.ImageBase] += 1
            if (prevAddr!=-1):
                offset=exp.address + pe.OPTIONAL_HEADER.ImageBase-prevAddr
                dictOffset[offset]+=1
                if (dictOffset[offset]>=3):
                    isOffsetVal = True
                    offsetName =exp.name
            prevAddr=exp.address + pe.OPTIONAL_HEADER.ImageBase
            if(d[exp.address + pe.OPTIONAL_HEADER.ImageBase]>=3):
                isSameAddr=True
                sameAddr=exp.address + pe.OPTIONAL_HEADER.ImageBase
            if(dictName[exp.name]=='1'):
                print ("Same name")
                isNameSame=True
                matchName=exp.name
            dictName[exp.name]='1'
            print("%s \t %s \t %s"  % (hex(exp.address + pe.OPTIONAL_HEADER.ImageBase), exp.name, exp.ordinal))
        print (dictName)
        if(isSameAddr | isOffsetVal|isNameSame):
            print("Malware detected!")
            if(isSameAddr):
                print("Three or more export functions have the same memory address!")
                print(hex(sameAddr))
            if (isOffsetVal):
                print("Three or more export functions have the same memory offset!")
                print(offsetName)
            if (isNameSame):
                print("Two or more export functions have the same name!")
                print(matchName)
        else:
            print("No malware detected!")
        
files = os. listdir(os.getcwd())
for name in files:
    if(os.path.isfile(name)):
        print(name)
        checkFile(name)
